variables:
  S3_BUCKET_DEV: origin.dev.ebi.emblstatic.net
  S3_BUCKET_PROD: origin.ebi.emblstatic.net
# do not define here, put in project variables
  AWS_KEY: key
  AWS_SECRET: secret-key

stages:
  - build
  - deploy

build:
  stage: build
  image: ebiwd/node-fontforge-grunt:6
  # https://github.com/ebiwd/dockerfile-node-fontforge-grunt/blob/master/Dockerfile
  tags:
    - docker
  before_script:
    - cd ${CI_PROJECT_DIR}
    - npm install --quiet
  script:
    - grunt
  cache:
    paths:
      - node_modules
  artifacts:
    paths:
      - '*/fonts'
      - '*/static'
      - fonts.css
      - partial.html

deploy_aws_dev:
  image: ebiwd/alpine-ssh
  stage: deploy
  tags:
    - docker
  before_script:
    - add-aws-key ${AWS_KEY} ${AWS_SECRET}
  script:
    - bin/deploy-aws
  only:
    - v1.3
  except:
    - /-code$/

deploy_aws_live:
  image: ebiwd/alpine-ssh
  stage: deploy
  tags:
    - docker
  before_script:
    - add-aws-key ${AWS_KEY} ${AWS_SECRET}
  script:
    - bin/deploy-aws prod
  only:
    - tags
